<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Richiesta Materiale (Interna)</title>
  <meta name="theme-color" content="#111111" />
  <style>
    *, *::before, *::after {box-sizing: border-box;}

    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#f6f6f6; color:#111; }
    .app { max-width: 720px; margin: 0 auto; padding: 16px; }
    .card { background:#fff; border-radius: 14px; padding: 14px; box-shadow: 0 8px 24px rgba(0,0,0,.06); }
    h1 { font-size: 18px; margin: 0 0 12px; }
    label { display:block; font-size: 12px; font-weight: 600; margin: 10px 0 6px; }
    input, textarea { width:100%; padding: 12px; border:1px solid #ddd; border-radius: 12px; font-size: 16px; background:#fff; }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .muted { color:#666; font-size: 12px; margin-top: 8px; }
    .items { margin-top: 12px; display:flex; flex-direction: column; gap:10px; }
    .item { border:1px solid #eee; border-radius: 14px; padding: 10px; }
    .item .row { align-items: center; }
    .btns { display:flex; gap:10px; flex-wrap: wrap; margin-top: 12px; }
    button { border:0; border-radius: 12px; padding: 12px 14px; font-size: 14px; font-weight: 700; cursor: pointer; }
    .primary { background:#111; color:#fff; }
    .ghost { background:#eee; color:#111; }
    .danger { background:#ffefef; color:#b00020; }
    textarea { min-height: 160px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    /* Scanner UI */
    .code-actions { display:flex; gap:8px; align-items:center; }
    .scan-btn { padding: 10px 12px; border-radius: 12px; background:#eee; font-weight:800; }
    .scan-btn:active { transform: scale(.99); }

    .modal {
      position: fixed; inset: 0; display:none;
      background: rgba(0,0,0,.55); z-index: 9999;
      align-items: center; justify-content: center;
      padding: 16px;
    }
    .modal.open { display:flex; }
    .modal-card {
      width: min(520px, 100%);
      background:#fff; border-radius: 16px; overflow:hidden;
      box-shadow: 0 16px 48px rgba(0,0,0,.25);
    }
    .modal-head {
      padding: 12px 14px; display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid #eee;
    }
    .modal-head strong { font-size: 14px; }
    .modal-body { padding: 12px 14px; }
    .video-wrap { position: relative; border-radius: 14px; overflow:hidden; background:#000; }
    video { width:100%; height:auto; display:block; }
    .hint {
      position:absolute;
      /* riquadro "orizzontale" per barcode */
      left: 10%; right: 10%;
      top: 40%; bottom: 40%;
      border: 2px solid rgba(255,255,255,.85);
      border-radius: 12px;
      box-shadow: 0 0 0 9999px rgba(0,0,0,.15) inset;
      pointer-events:none;
    }
    .scan-status { margin-top: 10px; font-size: 12px; color:#666; display:flex; gap:10px; flex-wrap:wrap; }
    .pill { padding: 6px 10px; border-radius: 999px; background:#f1f1f1; font-size:12px; font-weight:700; }
    .pill.bad { background:#ffe8e8; color:#b00020; }

    @media print {
      body { background:#fff; }
      .no-print { display:none !important; }
      .card { box-shadow:none; border:1px solid #ddd; }
      textarea { border:0; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="card no-print">
      <h1>RICHIESTA INTERNA MATERIALE</h1>

      <div class="row">
        <div>
          <label for="supplier">Fornitore</label>
          <input id="supplier" placeholder="Es. Casappa" autocomplete="off" />
        </div>
        <div>
          <label for="operator">Operatore</label>
          <input id="operator" placeholder="Es. Marco Rossi" />
        </div>
      </div>

      <div class="items" id="items"></div>

      <div style="margin-top:12px;">
        <button class="ghost" id="addRow" type="button">+ Aggiungi riga</button>
      </div>

      <hr style="margin: 3vh 0;">

      <div class="btns">
        <button class="primary" id="generate" type="button">Genera richiesta</button>
        <button class="ghost" id="copy" type="button">Copia testo</button>
        <button class="ghost" id="share" type="button">Condividi</button>
        <button class="ghost" id="print" type="button">Stampa</button>
        <button class="danger" id="reset" type="button">Svuota</button>
      </div>

      <div class="muted">
        Nessun dato viene salvato. Scanner ottimizzato per Code39 orizzontale (es. *523261027*).
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h1>Output</h1>
      <label for="output">Testo richiesta</label>
      <textarea id="output" placeholder="Premi â€œGenera richiestaâ€..."></textarea>
    </div>
  </div>

  <!-- Scanner Modal -->
  <div class="modal" id="scanModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <strong>Scansiona barcode (orizzontale)</strong>
        <button class="danger" id="closeScan" type="button">Chiudi</button>
      </div>
      <div class="modal-body">
        <div class="video-wrap">
          <video id="scanVideo" playsinline></video>
          <div class="hint" aria-hidden="true"></div>
        </div>
        <div class="scan-status">
          <span class="pill" id="scanPill">Avvio fotocameraâ€¦</span>
          <span class="pill" id="lastCodePill">Ultimo: â€”</span>
        </div>
        <div class="muted" style="margin-top:8px;">
          Consiglio: ruota il telefono in orizzontale, inquadra il codice dentro il riquadro e resta fermo 1â€“2 secondi.
        </div>
      </div>
    </div>
  </div>

<script>
  const els = {
    supplier: document.getElementById("supplier"),
    operator: document.getElementById("operator"),
    items: document.getElementById("items"),
    output: document.getElementById("output"),
    addRow: document.getElementById("addRow"),
    generate: document.getElementById("generate"),
    copy: document.getElementById("copy"),
    share: document.getElementById("share"),
    print: document.getElementById("print"),
    reset: document.getElementById("reset"),
    // scanner
    scanModal: document.getElementById("scanModal"),
    scanVideo: document.getElementById("scanVideo"),
    closeScan: document.getElementById("closeScan"),
    scanPill: document.getElementById("scanPill"),
    lastCodePill: document.getElementById("lastCodePill"),
  };

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  function addItemRow(code="", qty="") {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="row">
        <div>
          <label>Codice</label>
          <div class="code-actions">
            <input class="code" placeholder="Codice articolo" value="${escapeHtml(code)}" autocomplete="off" />
            <button class="scan-btn scan" type="button" title="Scansiona">ðŸ“·</button>
          </div>
        </div>
        <div style="max-width:140px;">
          <label>Q.tÃ </label>
          <input class="qty" type="number" min="0" step="1" placeholder="0" value="${escapeHtml(String(qty))}" />
        </div>
        <div style="max-width:90px; align-self:flex-end;">
          <button class="danger del" type="button" style="width:100%;">âœ•</button>
        </div>
      </div>
    `;

    div.querySelector(".del").addEventListener("click", () => div.remove());
    const codeInput = div.querySelector(".code");
    div.querySelector(".scan").addEventListener("click", () => openScannerFor(codeInput));

    els.items.appendChild(div);
  }

  function getItems() {
    const rows = [...els.items.querySelectorAll(".item")];
    return rows.map(r => {
      const code = r.querySelector(".code").value.trim();
      const qty  = r.querySelector(".qty").value.trim();
      return { code, qty: qty === "" ? "" : Number(qty) };
    }).filter(x => x.code || (x.qty !== "" && !Number.isNaN(x.qty)));
  }

  function formatNow() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  function generateText() {
    const supplier = els.supplier.value.trim();
    const operator = els.operator.value.trim();
    const items = getItems();

    if (!supplier) return alert("Inserisci il fornitore.");
    if (!operator) return alert("Inserisci il nome operatore.");
    if (items.length === 0) return alert("Inserisci almeno una riga (codice + quantitÃ ).");

    const lines = [];
    lines.push("RICHIESTA INTERNA MATERIALE");
    lines.push(`Data: ${formatNow()}`);
    lines.push(`Fornitore: ${supplier}`);
    lines.push(`Operatore: ${operator}`);
    lines.push("");

    items.forEach((it, idx) => {
      const q = (it.qty === "" || Number.isNaN(it.qty)) ? "" : ` â€” Q.tÃ  ${it.qty}`;
      lines.push(`${idx+1}) ${it.code}${q}`);
    });

    lines.push("");
    lines.push(`Totale righe: ${items.length}`);

    els.output.value = lines.join("\n");
  }

  async function copyText() {
    if (!els.output.value.trim()) return alert("Genera prima la richiesta.");
    await navigator.clipboard.writeText(els.output.value);
    alert("Copiato âœ…");
  }

  async function shareText() {
    if (!els.output.value.trim()) return alert("Genera prima la richiesta.");
    if (navigator.share) {
      await navigator.share({ text: els.output.value, title: "Richiesta interna materiale" });
    } else {
      alert("Condivisione non supportata qui. Usa â€œCopia testoâ€.");
    }
  }

  function resetAll() {
    if (!confirm("Svuotare tutto?")) return;
    els.supplier.value = "";
    els.operator.value = "";
    els.items.innerHTML = "";
    els.output.value = "";
    addItemRow();
    addItemRow();
  }

  /** =========================
   *  SCANNER BARCODE (camera) - migliorato per CODE39 orizzontale
   *  ========================= */
  let activeCodeInput = null;
  let scanStream = null;
  let scanTimer = null;
  let barcodeDetector = null;
  let lastDetected = { value: null, ts: 0 };

  // canvas per crop
  const cropCanvas = document.createElement("canvas");
  const cropCtx = cropCanvas.getContext("2d", { willReadFrequently: true });

  function setScanPill(text, ok=true) {
    els.scanPill.textContent = text;
    els.scanPill.classList.toggle("bad", !ok);
  }

  function cleanCode(raw) {
    // rimuove asterischi tipici Code39 + spazi
    return (raw || "").trim().replace(/^\*+|\*+$/g, "").replace(/\s+/g, "");
  }

  async function tryLockLandscape() {
    try {
      if (screen.orientation && screen.orientation.lock) {
        await screen.orientation.lock("landscape");
      }
    } catch {}
  }
  async function unlockOrientation() {
    try {
      if (screen.orientation && screen.orientation.unlock) screen.orientation.unlock();
    } catch {}
  }

  async function openScannerFor(codeInput) {
    activeCodeInput = codeInput;

    if (!navigator.mediaDevices?.getUserMedia) {
      alert("Fotocamera non disponibile su questo browser.");
      return;
    }
    if (!("BarcodeDetector" in window)) {
      alert("Scanner non supportato qui. Usa Chrome/Android oppure inserisci a mano.");
      return;
    }

    // Forza formati (molto importante per Code39)
    barcodeDetector = new window.BarcodeDetector({
      formats: ["code_39", "code_128", "ean_13", "ean_8", "itf", "upc_a", "upc_e", "qr_code"]
    });

    els.scanModal.classList.add("open");
    els.scanModal.setAttribute("aria-hidden", "false");
    setScanPill("Richiesta permesso fotocameraâ€¦", true);
    els.lastCodePill.textContent = "Ultimo: â€”";
    lastDetected = { value: null, ts: 0 };

    await tryLockLandscape();

    try {
      scanStream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });

      els.scanVideo.srcObject = scanStream;
      await els.scanVideo.play();

      // Prova ad attivare zoom (se supportato)
      const track = scanStream.getVideoTracks()[0];
      const caps = track.getCapabilities?.() || {};
      if (caps.zoom) {
        const targetZoom = Math.min(caps.zoom.max, Math.max(caps.zoom.min, 2));
        await track.applyConstraints({ advanced: [{ zoom: targetZoom }] }).catch(()=>{});
      }

      setScanPill("Tieni il barcode ORIZZONTALE nel riquadro", true);
      startDetectLoop();
    } catch (e) {
      console.error(e);
      setScanPill("Permesso negato o errore fotocamera", false);
    }
  }

  function startDetectLoop() {
    stopDetectLoop();

    scanTimer = setInterval(async () => {
      const v = els.scanVideo;
      if (!v || v.readyState < 2) return;

      try {
        // Crop centrale: molto meglio per barcode orizzontale
        const vw = v.videoWidth, vh = v.videoHeight;
        if (!vw || !vh) return;

        const cropW = Math.floor(vw * 0.78);
        const cropH = Math.floor(vh * 0.22);
        const sx = Math.floor((vw - cropW) / 2);
        const sy = Math.floor((vh - cropH) / 2);

        cropCanvas.width = cropW;
        cropCanvas.height = cropH;
        cropCtx.drawImage(v, sx, sy, cropW, cropH, 0, 0, cropW, cropH);

        const barcodes = await barcodeDetector.detect(cropCanvas);
        if (!barcodes || barcodes.length === 0) return;

        const raw = cleanCode(barcodes[0].rawValue);
        if (!raw) return;

        const now = Date.now();
        if (lastDetected.value === raw && (now - lastDetected.ts) < 1500) return;
        lastDetected = { value: raw, ts: now };

        els.lastCodePill.textContent = `Ultimo: ${raw}`;

        if (activeCodeInput) {
          activeCodeInput.value = raw;
          const qtyInput = activeCodeInput.closest(".row")?.querySelector(".qty");
          if (qtyInput) qtyInput.focus();
        }

        closeScanner();
      } catch (e) {
        // ignora errori sporadici
      }
    }, 180);
  }

  function stopDetectLoop() {
    if (scanTimer) { clearInterval(scanTimer); scanTimer = null; }
  }

  async function closeScanner() {
    stopDetectLoop();

    if (scanStream) {
      scanStream.getTracks().forEach(t => t.stop());
      scanStream = null;
    }
    els.scanVideo.srcObject = null;

    els.scanModal.classList.remove("open");
    els.scanModal.setAttribute("aria-hidden", "true");

    await unlockOrientation();
    activeCodeInput = null;
  }

  els.closeScan.addEventListener("click", closeScanner);
  els.scanModal.addEventListener("click", (e) => {
    if (e.target === els.scanModal) closeScanner();
  });

  /** actions **/
  els.addRow.addEventListener("click", () => addItemRow());
  els.generate.addEventListener("click", generateText);
  els.copy.addEventListener("click", copyText);
  els.share.addEventListener("click", shareText);
  els.print.addEventListener("click", () => { if (!els.output.value.trim()) generateText(); window.print(); });
  els.reset.addEventListener("click", resetAll);

  // init
  addItemRow();
  addItemRow();
</script>
</body>
</html>
